{"version":3,"file":"generateRetries.js","sourceRoot":"","sources":["../../src/utils/generateRetries.ts"],"names":[],"mappings":"AAAA,MAAM,aAAa,GAAG,GAAG,CAAC,CAAC,SAAS;AACpC,MAAM,aAAa,GAAG,CAAC,GAAG,EAAE,GAAG,IAAI,CAAC,CAAC,YAAY;AACjD,MAAM,kBAAkB,GAAG,CAAC,CAAC;AAE7B;;;;;;;;;;;;;;;;GAgBG;AACH,MAAM,CAAC,OAAO,CAAC,KAAK,SAAS,CAAC,CAAC,eAAe,CAC5C,IAAuC,EACvC,OAIC;IAED,MAAM,YAAY,GAAG,OAAO,EAAE,YAAY,IAAI,aAAa,CAAC;IAC5D,MAAM,YAAY,GAAG,OAAO,EAAE,YAAY,IAAI,aAAa,CAAC;IAC5D,MAAM,iBAAiB,GAAG,OAAO,EAAE,iBAAiB,IAAI,kBAAkB,CAAC;IAE3E,IAAI,KAAK,GAAG,YAAY,CAAC;IACzB,IAAI,SAAS,GAAG,IAAI,CAAC;IACrB,SAAS,KAAK;QACZ,SAAS,GAAG,IAAI,CAAC;IACnB,CAAC;IACD,OAAO,SAAS,EAAE;QAChB,6CAA6C;QAC7C,SAAS,GAAG,KAAK,CAAC;QAClB,MAAM,MAAM,GAAG,MAAM,MAAM,IAAI,CAAC,KAAK,CAAC,CAAC;QACvC,IAAI,SAAS,EAAE;YACb,MAAM,MAAM,IAAI,OAAO,CAAC,OAAO,CAAC,EAAE,CAAC,UAAU,CAAC,OAAO,EAAE,KAAK,CAAC,CAAC,CAAC;YAC/D,KAAK,GAAG,IAAI,CAAC,GAAG,CAAC,YAAY,EAAE,KAAK,GAAG,iBAAiB,CAAC,CAAC;SAC3D;aAAM;YACL,OAAO,MAAM,CAAC;SACf;KACF;IACD,uCAAuC;IACvC,OAAO;AACT,CAAC","sourcesContent":["const INITIAL_DELAY = 500; // 500 ms\nconst MAXIMUM_DELAY = 2 * 60 * 1000; // 2 minutes\nconst EXPONENTIAL_FACTOR = 2;\n\n/**\n * Function generator allowing iterating\n * over an asynchronous function being retried\n * at will. It implements simple exponential backoff\n * algorithm for calculating consecutive delays.\n *\n * It is used in `updatePushTokenAsync` to generate retries\n * of network request updating the push token on server.\n * If we were to use a regular asynchronous we wouldn't\n * be able to interrupt the execution between retries\n * (we would only be able to await the whole retry call).\n *\n * @param func The function to generate the retries of.\n * Receives a function as a single argument which it is expected\n * to call if it would like to be retried.\n * @param options Backoff customization options\n */\nexport default async function* generateRetries<T>(\n  func: (retry: () => void) => Promise<T>,\n  options?: {\n    initialDelay?: number;\n    maximumDelay?: number;\n    exponentialFactor?: number;\n  }\n): AsyncGenerator<T | undefined, T | undefined, T | undefined> {\n  const initialDelay = options?.initialDelay ?? INITIAL_DELAY;\n  const maximumDelay = options?.maximumDelay ?? MAXIMUM_DELAY;\n  const exponentialFactor = options?.exponentialFactor ?? EXPONENTIAL_FACTOR;\n\n  let delay = initialDelay;\n  let shouldTry = true;\n  function retry() {\n    shouldTry = true;\n  }\n  while (shouldTry) {\n    // If func doesn't call retry we won't retry.\n    shouldTry = false;\n    const result = yield await func(retry);\n    if (shouldTry) {\n      yield await new Promise(resolve => setTimeout(resolve, delay));\n      delay = Math.min(maximumDelay, delay * exponentialFactor);\n    } else {\n      return result;\n    }\n  }\n  // Unreachable code, appease TypeScript\n  return;\n}\n"]}